var vue=new Vue({el:"#messages-page",data:{conversations:[],newConversation:!1,recipients:[],currentConversation:{conversationMessages:[],user:[]},messageBody:""},created:function(){this.subscribeToPrivateMessageChannel(current_username),this.getConversations(),$(".coversations-thread").bind("scroll",this.chk_scroll),$(".coversations-list").bind("scroll",this.chk_scroll)},methods:{notify:function(e,s,t){noty({text:e,layout:"bottomLeft",type:"success",theme:"relax",timeout:1,animation:{open:"animated fadeIn",close:"animated fadeOut",easing:"swing",speed:500}})},timeago:function(){jQuery.timeago.settings.strings.suffixAgo="",jQuery.timeago.settings.strings.suffixFromNow="from now",jQuery.timeago.settings.strings.inPast="any moment now",jQuery.timeago.settings.strings.seconds="less than 1m",jQuery.timeago.settings.strings.minute="1m",jQuery.timeago.settings.strings.minutes="%dm",jQuery.timeago.settings.strings.hour="1h",jQuery.timeago.settings.strings.hours="%dh",jQuery.timeago.settings.strings.day="1d",jQuery.timeago.settings.strings.days="%dd",jQuery.timeago.settings.strings.month="1m",jQuery.timeago.settings.strings.months="%dm",jQuery.timeago.settings.strings.year="1y",jQuery.timeago.settings.strings.years="%dy",jQuery("time.microtime").timeago()},subscribeToPrivateMessageChannel:function(e){var s=this;this.pusher=new Pusher(pusherConfig.PUSHER_KEY,{encrypted:!0,auth:{headers:{"X-CSRF-Token":pusherConfig.token},params:{username:"vijay"}}}),this.MessageChannel=this.pusher.subscribe(e+"-message-created"),this.MessageChannel.bind("App\\Events\\MessagePublished",function(e){e.message.user=e.sender,s.currentConversation.id==e.message.thread_id?(s.currentConversation.conversationMessages.push(e.message),setTimeout(function(){s.timeago(),s.autoScroll(".coversations-thread")},100)):(indexes=$.map(s.conversations.data,function(s,t){if(s.id==e.message.thread_id)return t}),""!=indexes?(s.conversations.data[indexes[0]].unread=!0,s.conversations.data[indexes[0]].lastMessage=e.message):s.$http.post(base_url+"ajax/get-message/"+e.message.thread_id).then(function(e){s.conversations.data.unshift(e.data.data)}))})},getConversations:function(){this.$http.post(base_url+"ajax/get-messages").then(function(e){this.conversations=JSON.parse(e.body).data,this.showConversation(this.conversations.data[0])})},showConversation:function(e){this.newConversation=!1,e&&e.id!=this.currentConversation.id&&(e.unread=!1,this.$http.post(base_url+"ajax/get-conversation/"+e.id).then(function(s){this.currentConversation=JSON.parse(s.body).data,this.currentConversation.user=e.user,vm=this,setTimeout(function(){vm.autoScroll(".coversations-thread"),vm.timeago()},100)}))},postMessage:function(e){messageBody=this.messageBody,this.messageBody="",this.$http.post(base_url+"ajax/post-message/"+e.id,{message:messageBody}).then(function(e){e.status&&(this.currentConversation.conversationMessages.data.push(JSON.parse(e.body).data),vm=this,$("#messageReceipient").focus(),setTimeout(function(){vm.timeago(),vm.autoScroll(".coversations-thread")},100))})},postNewConversation:function(){this.recipients.length&&this.$http.post(base_url+"ajax/create-message",{message:this.messageBody,recipients:this.recipients}).then(function(e){e.status&&(vm=this,newThread=JSON.parse(e.body).data,indexes=$.map(vm.conversations.data,function(e,s){if(e.id==newThread.id)return s}),""!=indexes?(vm.conversations.data[indexes[0]].unread=!0,vm.conversations.data[indexes[0]].lastMessage=newThread.lastMessage):vm.conversations.data.unshift(e.data.data),$("#messageReceipient").focus(),this.recipients=[],this.newConversation=!1,this.messageBody="",this.showConversation(vm.conversations.data[0]),setTimeout(function(){vm.timeago(),vm.autoScroll(".coversations-thread")},100))})},autoScroll:function(e){$(e).animate({scrollTop:$(e)[0].scrollHeight+600},2e3)},chk_scroll:function(e){var s=$(e.currentTarget);s[0].scrollHeight-s.scrollTop()==s.outerHeight()&&("threads"==s.data("type")?this.getMoreConversations():this.getMoreConversationMessages())},getMoreConversationMessages:function(){this.currentConversation.conversationMessages.data.length<this.currentConversation.conversationMessages.total&&this.$http.post(this.currentConversation.conversationMessages.next_page_url).then(function(e){var s=JSON.parse(e.body).data;this.currentConversation.conversationMessages.last_page=s.conversationMessages.last_page,this.currentConversation.conversationMessages.next_page_url=s.conversationMessages.next_page_url,this.currentConversation.conversationMessages.per_page=s.conversationMessages.per_page,this.currentConversation.conversationMessages.prev_page_url=s.conversationMessages.prev_page_url;var t=this;$.each(s.conversationMessages.data,function(e,s){t.currentConversation.conversationMessages.data.unshift(s)}),setTimeout(function(){t.timeago()},10)})},getMoreConversations:function(){this.conversations.data.length<this.conversations.total&&this.$http.post(this.conversations.next_page_url).then(function(e){var s=JSON.parse(e.body).data;this.conversations.last_page=s.last_page,this.conversations.next_page_url=s.next_page_url,this.conversations.per_page=s.per_page,this.conversations.prev_page_url=s.prev_page_url;var t=this;$.each(s.data,function(e,s){t.conversations.data.unshift(s)}),setTimeout(function(){t.timeago()},10)})},showNewConversation:function(){this.newConversation=!0,this.currentConversation={user:[]},$("#messageReceipient").focus(),vm=this,setTimeout(function(){vm.toggleUsersSelectize()},10)},toggleUsersSelectize:function(){vm=this;var e=$("#messageReceipient").selectize({valueField:"id",labelField:"name",searchField:"name",render:{option:function(e,s){return'<div class="media big-search-dropdown"><a class="media-left" href="#"><img src="'+e.avatar+'" alt="..."></a><div class="media-body"><h4 class="media-heading">'+s(e.name)+"</h4><p>"+e.username+"</p></div></div>"}},onChange:function(s){$('[name="user_tags"]').val(s);var t=e[0].selectize;vm.recipients=t.items},load:function(e,s){if(!e.length)return s();$.ajax({url:base_url+"api/v1/users",type:"GET",dataType:"json",data:{search:e},error:function(){s()},success:function(e){s(e.data)}})}})}}});