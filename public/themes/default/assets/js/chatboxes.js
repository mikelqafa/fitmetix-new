var chatBoxes=new Vue({el:"#chatBoxes",data:{chatBoxes:[],messageBody:"",conversations:[]},created:function(){this.subscribeToPrivateMessageChannel(current_username),this.getConversations(),$(".chat-conversation-list").bind("scroll",this.chk_scroll),$(".following-group").bind("scroll",this.chk_scroll_bottom)},methods:{notify:function(e,s,t){noty({text:e,layout:"bottomLeft",type:"success",theme:"relax",timeout:1,animation:{open:"animated fadeIn",close:"animated fadeOut",easing:"swing",speed:500}})},timeago:function(){jQuery.timeago.settings.strings.suffixAgo="",jQuery.timeago.settings.strings.suffixFromNow="from now",jQuery.timeago.settings.strings.inPast="any moment now",jQuery.timeago.settings.strings.seconds="less than 1m",jQuery.timeago.settings.strings.minute="1m",jQuery.timeago.settings.strings.minutes="%dm",jQuery.timeago.settings.strings.hour="1h",jQuery.timeago.settings.strings.hours="%dh",jQuery.timeago.settings.strings.day="1d",jQuery.timeago.settings.strings.days="%dd",jQuery.timeago.settings.strings.month="1m",jQuery.timeago.settings.strings.months="%dm",jQuery.timeago.settings.strings.year="1y",jQuery.timeago.settings.strings.years="%dy",jQuery("time.microtime").timeago()},autoScroll:function(e){$(e).animate({scrollTop:$(e)[0].scrollHeight+600},2e3)},subscribeToPrivateMessageChannel:function(e){var s=this;this.pusher=new Pusher(pusherConfig.PUSHER_KEY,{encrypted:!0,auth:{headers:{"X-CSRF-Token":pusherConfig.token},params:{username:"vijay"}}}),this.MessageChannel=this.pusher.subscribe(e+"-message-created"),this.MessageChannel.bind("App\\Events\\MessagePublished",function(e){indexes=$.map(s.chatBoxes,function(s,t){if(s.id==e.message.thread_id)return t}),indexes[0]>=0?(e.message.user=e.sender,s.chatBoxes[indexes[0]].conversationMessages.data.push(e.message),s.autoScroll(".chat-conversation")):(conversation=[],conversation.id=e.message.thread_id,conversation.user=e.sender,s.showChatBox(conversation))})},getConversations:function(){this.$http.post(base_url+"ajax/get-messages").then(function(e){this.conversations=JSON.parse(e.body).data})},showConversation:function(e){e&&e.id!=this.currentConversation.id&&(e.unread=!1,this.$http.post(base_url+"ajax/get-conversation/"+e.id).then(function(s){this.currentConversation=JSON.parse(s.body).data,this.currentConversation.user=e.user,vm=this,setTimeout(function(){vm.timeago()},100)}))},postMessage:function(e){""!=e.newMessage&&this.$http.post(base_url+"ajax/post-message/"+e.id,{message:e.newMessage}).then(function(s){s.status&&(e.conversationMessages.data.push(JSON.parse(s.body).data),e.newMessage="",vm=this,setTimeout(function(){vm.autoScroll(".chat-conversation")},100))})},showChatBox:function(e){indexes=$.map(this.chatBoxes,function(s,t){if(s.id==e.id)return t}),indexes[0]>=0?console.log("prevented second opening of chat box"):this.$http.post(base_url+"ajax/get-conversation/"+e.id).then(function(s){if(s.status){var t=JSON.parse(s.body).data;t.newMessage="",t.user=e.user,t.minimised=!1,this.chatBoxes.push(t),vm=this,setTimeout(function(){vm.autoScroll(".chat-conversation")},100)}})},sendMessage:function(e){indexes=$.map(this.conversations.data,function(s,t){if(s.user&&s.user.id==e)return t}),indexes[0]>=0?this.showChatBox(this.conversations.data[indexes[0]]):this.$http.post(base_url+"ajax/get-private-conversation/"+e).then(function(e){e.status&&this.showChatBox(e.data.data)})},chk_scroll:function(e){0==$(e.currentTarget).scrollTop()&&this.getMoreConversationMessages()},getMoreConversationMessages:function(){this.currentConversation.conversationMessages.data.length<this.currentConversation.conversationMessages.total&&this.$http.post(this.currentConversation.conversationMessages.next_page_url).then(function(e){var s=JSON.parse(e.body).data;this.currentConversation.conversationMessages.last_page=s.conversationMessages.last_page,this.currentConversation.conversationMessages.next_page_url=s.conversationMessages.next_page_url,this.currentConversation.conversationMessages.per_page=s.conversationMessages.per_page,this.currentConversation.conversationMessages.prev_page_url=s.conversationMessages.prev_page_url;var t=this;$.each(s.conversationMessages.data,function(e,s){t.currentConversation.conversationMessages.data.unshift(s)}),setTimeout(function(){t.timeago()},10)})},chk_scroll_bottom:function(e){var s=$(e.currentTarget);s[0].scrollHeight-s.scrollTop()==s.outerHeight()&&this.getMoreConversations()},getMoreConversations:function(){this.conversations.data.length<this.conversations.total&&this.$http.post(this.conversations.next_page_url).then(function(e){var s=JSON.parse(e.body).data;this.conversations.last_page=s.last_page,this.conversations.next_page_url=s.next_page_url,this.conversations.per_page=s.per_page,this.conversations.prev_page_url=s.prev_page_url;var t=this;$.each(s.data,function(e,s){t.conversations.data.unshift(s)}),setTimeout(function(){t.timeago()},10)})}}});